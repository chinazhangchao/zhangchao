<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Rails中的MIME类型解析规则 | 张超的博客</title>
    <meta property="og:title" content="Rails中的MIME类型解析规则 - 张超的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-08-24T11:46:54&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-08-24T11:46:54&#43;08:00'>
        
    <meta name="Keywords" content="[Rails MIME]">
    <meta name="description" content="Rails中的MIME类型解析规则">
        
    <meta name="author" content="张超">
    <meta property="og:url" content="https://zhangchao.xyz/rails/mime-parse/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangchao.xyz/">
                        张超的博客
                    </a>
                
                <p class="description">记录一些思考</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangchao.xyz/">首页</a>
                    
                    <a  href="https://zhangchao.xyz/archives/" title="归档">归档</a>
                    
                    <a  href="https://zhangchao.xyz/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Rails中的MIME类型解析规则</h1>
        </header>
        <date class="post-meta meta-date">
            2019年8月24日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://zhangchao.xyz/categories/rails'>Rails</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <p>本文缘于在项目中遇到的一个问题，查阅了网上的资料和Rails源码后有一点收获，简单做个总结，有些地方不够全面，欢迎大家补充指正。</p>
<h1 id="相关背景">相关背景</h1>
<p>Rails项目中经常可以看到类似如下代码：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">respond_to <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">|</span>
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>html
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>json { render <span style="color:#990073">json</span>: <span style="color:#008080">@users</span> }
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>xml  { render <span style="color:#990073">xml</span>: <span style="color:#008080">@users</span> }
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>如果想获取xml格式的数据，就在请求路径后面增加<code>.xml</code>扩展名，比如<code>localhost:3000/users.xml</code>，这样就可以拿到xml格式的返回。</p>
<p><strong>路径扩展名是Rails中MIME类型解析的一个影响因素，另一个影响因素是HTTP头字段Accept。</strong></p>
<h2 id="http头字段accept">HTTP头字段Accept</h2>
<p>当浏览器发送请求的时候，它也会通知服务器自己能处理的内容类型。访问网站的时候可以通过浏览器的开发者工具查看它们发送的Accept头。</p>
<p>下面是我的机器上不同浏览器发送的Accept头：</p>
<pre><code>Chrome: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Firefox: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Safari: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
</code></pre><p>让我们看看Chrome的Accept头：</p>
<pre><code>Chrome: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
</code></pre><p>Chrome的头表明它可以处理html文档（text/html）、xhtml文档（application/xhtml+xml）、xml文档（application/xml）、webp和apng格式的图片，以及其它别的格式。</p>
<p>Accept头里面有一个q值，它表示优先级。HTTP标准里面是这么描述的（<a href="https://tools.ietf.org/html/rfc7231#section-5.3.1">https://tools.ietf.org/html/rfc7231#section-5.3.1</a>）：</p>
<blockquote>
<p>5.3.1.  Quality Values</p>
</blockquote>
<blockquote>
<p>Many of the request header fields for proactive negotiation use a common parameter, named &ldquo;q&rdquo; (case-insensitive), to assign a relative &ldquo;weight&rdquo; to the preference for that associated kind of content.  This weight is referred to as a &ldquo;quality value&rdquo; (or &ldquo;qvalue&rdquo;) because the same parameter name is often used within server configurations to assign a weight to the relative quality of the various representations that can be selected for a resource.</p>
</blockquote>
<blockquote>
<p>The weight is normalized to a real number in the range 0 through 1, where 0.001 is the least preferred and 1 is the most preferred; a value of 0 means &ldquo;not acceptable&rdquo;.  If no &ldquo;q&rdquo; parameter is present, the default weight is 1.</p>
</blockquote>
<p>简单说就是为了表示Accept中内容类型的优先级，使用一个参数q来作为权重，q是一个0到1之间的实数，最小是0.001，最大是1。如果是0表示不接受这种内容类型。如果没有指定，q默认值为1。</p>
<p>Accept内容类型的优先级除了与q值和顺序有关，还与类型具体化程度有关，越具体的类型优先级越高（<a href="https://tools.ietf.org/html/rfc7231#section-5.3.2">https://tools.ietf.org/html/rfc7231#section-5.3.2</a>）：</p>
<blockquote>
<p>Media ranges can be overridden by more specific media ranges or
specific media types.  If more than one media range applies to a
given type, the most specific reference has precedence.</p>
</blockquote>
<p>举RFC里的例子：</p>
<pre><code>Accept: text/*, text/plain, text/plain;format=flowed, */*
</code></pre><p>这个Accept头里，类型优先级如下：</p>
<ol>
<li>text/plain;format=flowed</li>
<li>text/plain</li>
<li>text/*</li>
<li><em>/</em></li>
</ol>
<p>关于Accept优先级到此为止，不继续深究，有兴趣的同学可以阅读RFC原文。</p>
<h1 id="遇到的问题">遇到的问题</h1>
<p>我们的项目采用前后端分离的写法，后端controller中有如下代码：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">respond_to <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">|</span>
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>html <span style="color:#000;font-weight:bold">do</span>
    flash<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:alert</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;用户密码被重置，请重新登录&#39;</span>
    redirect_to new_user_session_path
  <span style="color:#000;font-weight:bold">end</span>

  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>json <span style="color:#000;font-weight:bold">do</span>
    render(<span style="color:#990073">json</span>: {
              <span style="color:#990073">code</span>: <span style="color:#099">0</span>,
              <span style="color:#990073">location</span>: new_user_session_path,
              <span style="color:#990073">msg</span>: <span style="color:#d14">&#39;用户密码被重置，请重新登录&#39;</span>
            })
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>前端发送的请求头中Accept字段如下：</p>
<p><code>Accept: application/json, text/plain, */*</code></p>
<p>按我的理解，接口应该返回json数据，结果返回的是html重定向。
经过后来几次测试、跟踪源码，现象如下：</p>
<table>
<thead>
<tr>
<th>Accept</th>
<th>返回</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>application/json, text/plain, */*</code></td>
<td>html重定向</td>
</tr>
<tr>
<td><code>application/json, text/plain</code></td>
<td>json数据</td>
</tr>
<tr>
<td><code>*/*</code></td>
<td>与respond_to代码块中声明格式的顺序有关，即<code>format.html</code>、<code>format.json</code>哪个在前，返回哪个</td>
</tr>
</tbody>
</table>
<p>除了第一条，后面两条基本还是符合直觉的。接下来看看Rails判断返回格式的规则到底是什么样的？</p>
<h1 id="rails对mime的解析">Rails对MIME的解析</h1>
<p>答案当然要从Rails源码中找（Read the fucking source code ^_^），涉及的函数如下（在文件<code>rails/actionpack/lib/action_dispatch/http/mime_negotiation.rb</code>中，代码细节先不用深究，后文还有分析）：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># order是在respond_to代码块中声明的返回格式数组，formats函数返回前端需要的格式数组，见后面的定义</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">negotiate_mime</span>(order)
  formats<span style="color:#000;font-weight:bold">.</span>each <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>priority<span style="color:#000;font-weight:bold">|</span>
    <span style="color:#000;font-weight:bold">if</span> priority <span style="color:#000;font-weight:bold">==</span> <span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">ALL</span>
      <span style="color:#000;font-weight:bold">return</span> order<span style="color:#000;font-weight:bold">.</span>first
    <span style="color:#000;font-weight:bold">elsif</span> order<span style="color:#000;font-weight:bold">.</span>include?(priority)
      <span style="color:#000;font-weight:bold">return</span> priority
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>

  order<span style="color:#000;font-weight:bold">.</span>include?(<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">ALL</span>) ? <span style="color:#0086b3">format</span> : <span style="color:#000;font-weight:bold">nil</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># formats函数解析前端需要的格式，返回解析后的格式数组</span>
<span style="color:#998;font-style:italic"># 其中第二个条件分支中的accepts函数会解析Accept字段，注意前提是有Accept头并且校验合法</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">formats</span>
  fetch_header(<span style="color:#d14">&#34;action_dispatch.request.formats&#34;</span>) <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>k<span style="color:#000;font-weight:bold">|</span>
    params_readable <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">begin</span>
                        parameters<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:format</span><span style="color:#000;font-weight:bold">]</span>
                      <span style="color:#000;font-weight:bold">rescue</span> <span style="color:#008080">ActionController</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">BadRequest</span>
                        <span style="color:#000;font-weight:bold">false</span>
                      <span style="color:#000;font-weight:bold">end</span>

    v <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">if</span> params_readable
      <span style="color:#0086b3">Array</span>(<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">[</span>parameters<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:format</span><span style="color:#000;font-weight:bold">]]</span>)
    <span style="color:#000;font-weight:bold">elsif</span> use_accept_header <span style="color:#000;font-weight:bold">&amp;&amp;</span> valid_accept_header
      accepts
    <span style="color:#000;font-weight:bold">elsif</span> extension_format <span style="color:#000;font-weight:bold">=</span> format_from_path_extension
      <span style="color:#000;font-weight:bold">[</span>extension_format<span style="color:#000;font-weight:bold">]</span>
    <span style="color:#000;font-weight:bold">elsif</span> xhr?
      <span style="color:#000;font-weight:bold">[</span><span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:js</span><span style="color:#000;font-weight:bold">]]</span>
    <span style="color:#000;font-weight:bold">else</span>
      <span style="color:#000;font-weight:bold">[</span><span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:html</span><span style="color:#000;font-weight:bold">]]</span>
    <span style="color:#000;font-weight:bold">end</span>
    set_header k, v
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># accepts函数调用Mime::Type.parse完成真正的解析工作</span>
<span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">accepts</span>
  fetch_header(<span style="color:#d14">&#34;action_dispatch.request.accepts&#34;</span>) <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>k<span style="color:#000;font-weight:bold">|</span>
    header <span style="color:#000;font-weight:bold">=</span> get_header(<span style="color:#d14">&#34;HTTP_ACCEPT&#34;</span>)<span style="color:#000;font-weight:bold">.</span>to_s<span style="color:#000;font-weight:bold">.</span>strip

    v <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">if</span> header<span style="color:#000;font-weight:bold">.</span>empty?
      <span style="color:#000;font-weight:bold">[</span>content_mime_type<span style="color:#000;font-weight:bold">]</span>
    <span style="color:#000;font-weight:bold">else</span>
      <span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>parse(header)
    <span style="color:#000;font-weight:bold">end</span>
    set_header k, v
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">private</span>

  <span style="color:#998;font-style:italic"># 这个正则表达式是用来判断是否是浏览器发出的请求，不是浏览器发出的请求才返回true</span>
  <span style="color:#008080">BROWSER_LIKE_ACCEPTS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#009926">/,\s*\*\/\*|\*\/\*\s*,/</span>

  <span style="color:#998;font-style:italic"># 校验函数，在formats中被调用，用来检查Accept是否正确</span>
  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">valid_accept_header</span> <span style="color:#998;font-style:italic"># :doc:</span>
    (xhr? <span style="color:#000;font-weight:bold">&amp;&amp;</span> (accept<span style="color:#000;font-weight:bold">.</span>present? <span style="color:#000;font-weight:bold">||</span> content_mime_type)) <span style="color:#000;font-weight:bold">||</span>
      (accept<span style="color:#000;font-weight:bold">.</span>present? <span style="color:#000;font-weight:bold">&amp;&amp;</span> accept <span style="color:#000;font-weight:bold">!~</span> <span style="color:#008080">BROWSER_LIKE_ACCEPTS</span>)
      <span style="color:#998;font-style:italic"># 此处是问题的关键，如果accept头里包含*/*和其他类型（如：Accept: application/json, text/plain, */*）则此函数返回false，</span>
      <span style="color:#998;font-style:italic"># 因此formats函数里不会解析Accept，Accept不起作用，formats函数继续往下走，走到了else分支返回html。</span>
      <span style="color:#998;font-style:italic"># 如果只有*/*（Accept: */*），此函数返回true，negotiate_mime函数会选择respond代码块里的第一个格式类型返回（详细分析见下文）</span>
  <span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>通过以上代码，可以大体看出Rails对返回格式的判断流程：</p>
<ol>
<li>判断请求是否带format后缀，如果带，则返回相应格式。如：http://localhost:3000/users.xml。</li>
<li>判断请求是否有Accept头并且是合法头，如果是，则解析Accept，返回Accept中的格式。</li>
<li>判断请求是否有<code>format_from_path_extension</code>的格式，不好意思，这个暂时没来得及研究是啥，欢迎大神们补充^_^。</li>
<li>判断请求是否是Ajax调用，如果是，返回javascript格式数据。</li>
<li>以上都不满足，返回html格式。</li>
</ol>
<h2 id="对浏览器的特殊处理">对浏览器的特殊处理</h2>
<p>从上面的代码里看到，Rails对浏览器发出的请求做了特殊处理，如果是浏览器发出的，则不解析Accept头。为什么要对浏览器的请求做特殊处理？查阅的资料显示是因为早期浏览器设计不规范，大部分浏览器的请求头Accept字段第一个值是<code>application/xml</code>，如果按照Accept解析就会给浏览器用户返回xml格式的数据，而这通常不是浏览器用户想要的。因此判断如果是浏览器就直接忽略Accept头。</p>
<p>最后总结一下Accept的三种情形。</p>
<h2 id="accept三种情形">Accept三种情形</h2>
<h3 id="1-accept不包含">1. Accept不包含*/*</h3>
<p>假设接口中有如下代码：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">respond_to <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">|</span>
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>html { render <span style="color:#990073">html</span>: <span style="color:#d14">&#39;&lt;p&gt;this is html&lt;/p&gt;&#39;</span><span style="color:#000;font-weight:bold">.</span>html_safe }
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>json { render <span style="color:#990073">json</span>: { <span style="color:#990073">data</span>: <span style="color:#d14">&#39;this is json&#39;</span> } }
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>Accept的值为：</p>
<pre><code>application/json, text/plain
</code></pre><p>此时<code>formats</code>函数中<code>valid_accept_header</code>返回true，Rails会解析Accept，<code>formats</code>函数最终返回如下格式顺序的数组：</p>
<pre><code>json
plain
</code></pre><p><code>negotiate_mime</code>函数中的<code>order</code>数组中包含的格式是：</p>
<pre><code>html
json
</code></pre><p>这种情况下，代码遍历<code>formats</code>，如果<code>order</code>中有匹配的格式就返回。<code>format</code>的第一个格式是json，<code>order</code>中有匹配，此时返回json数据。</p>
<p><strong>结论：Accept不包含*/*时，按照Accept的优先级返回。</strong></p>
<h3 id="2-accept头是">2. Accept头是*/*</h3>
<p>Accept的值为：</p>
<pre><code>*/*
</code></pre><p>接口代码如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">respond_to <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">|</span>
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>html { render <span style="color:#990073">html</span>: <span style="color:#d14">&#39;&lt;p&gt;this is html&lt;/p&gt;&#39;</span><span style="color:#000;font-weight:bold">.</span>html_safe }
  <span style="color:#0086b3">format</span><span style="color:#000;font-weight:bold">.</span>json { render <span style="color:#990073">json</span>: { <span style="color:#990073">data</span>: <span style="color:#d14">&#39;this is json&#39;</span> } }
<span style="color:#000;font-weight:bold">end</span>
</code></pre></td></tr></table>
</div>
</div><p>此时返回html格式。</p>
<p>把<code>respond_to</code>代码块调整一下顺序：</p>
<pre><code>respond_to do |format|
  format.json { render json: { data: 'this is json' } }
  format.html { render html: '&lt;p&gt;this is html&lt;/p&gt;'.html_safe }
end
</code></pre><p>此时返回json格式。</p>
<p>Accept头是*/*时，解析Accept的结果为<code>Mime::ALL</code>类型，从<code>negotiate_mime</code>函数代码中可以明显看出，当请求类型为<code>Mime::ALL</code>时，选择<code>order</code>中的第一个格式返回，此时会返回<code>respond_to</code>代码块中的第一个格式。</p>
<p>如果没有<code>respond_to</code>代码块呢？如果没有<code>respond_to</code>代码块，但是在view目录下有<code>test.html.erb</code>、<code>test.json.jbuilder</code>两个文件，Rails返回什么格式？这种情况下，Rails按顺序遍历所有注册的Mime格式，找对应的匹配文件，一旦找到文件就返回该格式。这种情况下的返回格式依赖Mime格式的注册顺序，下面是Mime格式注册的代码（<code>rails/actionpack/lib/action_dispatch/http/mime_types.rb</code>）：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/html&#34;</span>, <span style="color:#990073">:html</span>, <span style="color:#d14">%w( application/xhtml+xml )</span>, <span style="color:#d14">%w( xhtml )</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/plain&#34;</span>, <span style="color:#990073">:text</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(txt)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/javascript&#34;</span>, <span style="color:#990073">:js</span>, <span style="color:#d14">%w( application/javascript application/x-javascript )</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/css&#34;</span>, <span style="color:#990073">:css</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/calendar&#34;</span>, <span style="color:#990073">:ics</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/csv&#34;</span>, <span style="color:#990073">:csv</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/vcard&#34;</span>, <span style="color:#990073">:vcf</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;text/vtt&#34;</span>, <span style="color:#990073">:vtt</span>, <span style="color:#d14">%w(vtt)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/png&#34;</span>, <span style="color:#990073">:png</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(png)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/jpeg&#34;</span>, <span style="color:#990073">:jpeg</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(jpg jpeg jpe pjpeg)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/gif&#34;</span>, <span style="color:#990073">:gif</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(gif)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/bmp&#34;</span>, <span style="color:#990073">:bmp</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(bmp)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/tiff&#34;</span>, <span style="color:#990073">:tiff</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(tif tiff)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;image/svg+xml&#34;</span>, <span style="color:#990073">:svg</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;video/mpeg&#34;</span>, <span style="color:#990073">:mpeg</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(mpg mpeg mpe)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;audio/mpeg&#34;</span>, <span style="color:#990073">:mp3</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(mp1 mp2 mp3)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;audio/ogg&#34;</span>, <span style="color:#990073">:ogg</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(oga ogg spx opus)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;audio/aac&#34;</span>, <span style="color:#990073">:m4a</span>, <span style="color:#d14">%w( audio/mp4 )</span>, <span style="color:#d14">%w(m4a mpg4 aac)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;video/webm&#34;</span>, <span style="color:#990073">:webm</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(webm)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;video/mp4&#34;</span>, <span style="color:#990073">:mp4</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(mp4 m4v)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;font/otf&#34;</span>, <span style="color:#990073">:otf</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(otf)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;font/ttf&#34;</span>, <span style="color:#990073">:ttf</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(ttf)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;font/woff&#34;</span>, <span style="color:#990073">:woff</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(woff)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;font/woff2&#34;</span>, <span style="color:#990073">:woff2</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(woff2)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/xml&#34;</span>, <span style="color:#990073">:xml</span>, <span style="color:#d14">%w( text/xml application/x-xml )</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/rss+xml&#34;</span>, <span style="color:#990073">:rss</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/atom+xml&#34;</span>, <span style="color:#990073">:atom</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/x-yaml&#34;</span>, <span style="color:#990073">:yaml</span>, <span style="color:#d14">%w( text/yaml )</span>, <span style="color:#d14">%w(yml yaml)</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;multipart/form-data&#34;</span>, <span style="color:#990073">:multipart_form</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/x-www-form-urlencoded&#34;</span>, <span style="color:#990073">:url_encoded_form</span>

<span style="color:#998;font-style:italic"># https://www.ietf.org/rfc/rfc4627.txt</span>
<span style="color:#998;font-style:italic"># http://www.json.org/JSONRequest.html</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/json&#34;</span>, <span style="color:#990073">:json</span>, <span style="color:#d14">%w( text/x-json application/jsonrequest )</span>

<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/pdf&#34;</span>, <span style="color:#990073">:pdf</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(pdf)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/zip&#34;</span>, <span style="color:#990073">:zip</span>, <span style="color:#000;font-weight:bold">[]</span>, <span style="color:#d14">%w(zip)</span>
<span style="color:#008080">Mime</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Type</span><span style="color:#000;font-weight:bold">.</span>register <span style="color:#d14">&#34;application/gzip&#34;</span>, <span style="color:#990073">:gzip</span>, <span style="color:#d14">%w(application/x-gzip)</span>, <span style="color:#d14">%w(gz)</span>
</code></pre></td></tr></table>
</div>
</div><p>很明显，<code>text/html</code>是第一个格式，因此在本例中返回<code>test.html.erb</code>文件内容。</p>
<p><strong>结论：Accept头是*/*时，返回<code>respond_to</code>代码块中的第一个格式。没有<code>respond_to</code>代码块时，按Mime格式注册顺序寻找对应文件返回。</strong></p>
<h3 id="3-accept头包含和其他内容">3. Accept头包含*/*和其他内容</h3>
<p>Accept的值为：</p>
<pre><code>application/json, text/plain, */*
</code></pre><p>接口代码如下：</p>
<pre><code>respond_to do |format|
  format.json { render json: { data: 'this is json' } }
  format.html { render html: '&lt;p&gt;this is html&lt;/p&gt;'.html_safe }
end
</code></pre><p>暂时不考虑流程中的3、4，此时返回html，不会解析Accept头（原因在于<code>valid_accept_header</code>函数返回false，对浏览器的特殊处理），也不会受<code>respond_to</code>代码块顺序影响。</p>
<p><strong>结论：Accept头包含*/*和其他内容，返回html。</strong></p>
<p>文笔不好，内容又多，写的有点乱，大家见谅。</p>
<p>参考资料：</p>
<p><a href="https://blog.bigbinary.com/2010/11/23/mime-type-resolution-in-rails.html">https://blog.bigbinary.com/2010/11/23/mime-type-resolution-in-rails.html</a></p>
<p><a href="https://github.com/rails/rails/issues/9940">https://github.com/rails/rails/issues/9940</a></p>
<p><a href="https://tools.ietf.org/html/rfc7231#section-5.3.1">https://tools.ietf.org/html/rfc7231#section-5.3.1</a></p>
<p><a href="https://tools.ietf.org/html/rfc7231#section-5.3.2">https://tools.ietf.org/html/rfc7231#section-5.3.2</a></p>

        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/ruby/magic-comment/">Ruby 2.3中的魔法注释# frozen_string_literal: true</a></li>
        
        <li><a href="/ruby/safe-navigation-operator/">Ruby 安全调用运算符 (&amp;.)</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://zhangchao.xyz/tags/rails'>Rails</a></li>
                
                <li><a href='https://zhangchao.xyz/tags/ruby'>Ruby</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "chinazhangchao/zhangchao-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangchao.xyz/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="搜索">
      <input type="hidden" name="sitesearch" value="https://zhangchao.xyz/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangchao.xyz/english/word-things-2/" title="单词那些事（2）——一览众山小">单词那些事（2）——一览众山小</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/english/word-things-1/" title="单词那些事（1）——胸中有丘壑">单词那些事（1）——胸中有丘壑</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/math/best-math-books/" title="最好的数学书">最好的数学书</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/tool/sublime-text-snippets-intro/" title="Sublime Text使用代码片段Snippets高效写作">Sublime Text使用代码片段Snippets高效写作</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/tool/sublime-text-3-increase-recent-file-number-mac/" title="Sublime Text 3增加最近打开的文件数量（Mac）">Sublime Text 3增加最近打开的文件数量（Mac）</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/tool/sublime-text-3-increase-recent-file-number-windows/" title="Sublime Text 3增加最近打开的文件数量（Windows）">Sublime Text 3增加最近打开的文件数量（Windows）</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/tool/pdf-to-text/" title="扫描版PDF文档转文本方法">扫描版PDF文档转文本方法</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/ruby/string-encoding/" title="Ruby字符串编码">Ruby字符串编码</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/leetcode/num2/" title="LeetCode-2. Add Two Numbers（两数相加）C&#43;&#43;实现">LeetCode-2. Add Two Numbers（两数相加）C&#43;&#43;实现</a>
    </li>
    
    <li>
        <a href="https://zhangchao.xyz/leetcode/num1/" title="LeetCode-1. Two Sum（两数之和）C&#43;&#43;实现">LeetCode-1. Two Sum（两数之和）C&#43;&#43;实现</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://zhangchao.xyz/categories/c&#43;&#43;/">C&#43;&#43; (6)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/leetcode/">LeetCode (3)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/rails/">Rails (1)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/ruby/">Ruby (3)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/%E5%B7%A5%E5%85%B7/">工具 (4)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/%E6%95%B0%E5%AD%A6/">数学 (1)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/%E8%8B%B1%E8%AF%AD/">英语 (2)</a></li>
    
    <li><a href="https://zhangchao.xyz/categories/%E8%B4%A2%E5%AF%8C/">财富 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://zhangchao.xyz/tags/c&#43;&#43;/">C&#43;&#43;</a>
    
    <a href="https://zhangchao.xyz/tags/leetcode/">LeetCode</a>
    
    <a href="https://zhangchao.xyz/tags/rails/">Rails</a>
    
    <a href="https://zhangchao.xyz/tags/ruby/">Ruby</a>
    
    <a href="https://zhangchao.xyz/tags/sublime-text/">sublime text</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%8D%95%E8%AF%8D/">单词</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%A0%86%E6%8E%92%E5%BA%8F/">堆排序</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%A5%BD%E4%B9%A6/">好书</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%B7%A5%E5%85%B7/">工具</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/">归并排序</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%BE%AE%E7%A7%AF%E5%88%86/">微积分</a>
    
    <a href="https://zhangchao.xyz/tags/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F/">快速排序</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%95%99%E6%9D%90/">教材</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%95%B0%E5%AD%A6/">数学</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/">构造函数</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/">析构函数</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%A6%82%E7%8E%87%E8%AE%BA/">概率论</a>
    
    <a href="https://zhangchao.xyz/tags/%E6%AF%8F%E5%91%A8%E5%B7%A5%E4%BD%9C4%E5%B0%8F%E6%97%B6/">每周工作4小时</a>
    
    <a href="https://zhangchao.xyz/tags/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/">线性代数</a>
    
    <a href="https://zhangchao.xyz/tags/%E8%8B%B1%E8%AF%AD/">英语</a>
    
    <a href="https://zhangchao.xyz/tags/%E8%B4%A2%E5%AF%8C%E8%87%AA%E7%94%B1/">财富自由</a>
    
    <a href="https://zhangchao.xyz/tags/%E8%B5%9A%E9%92%B1/">赚钱</a>
    
    <a href="https://zhangchao.xyz/tags/%E9%AB%98%E7%AD%89%E6%95%B0%E5%AD%A6/">高等数学</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.danci.fun/" title="单词范——最快速的背单词方法">单词范——最快速的背单词方法</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://zhangchao.xyz/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://zhangchao.xyz/">张超的博客 By 张超</a>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-144916691-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>